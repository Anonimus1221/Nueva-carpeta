<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - {{ map.title }}</title>
    <link rel="stylesheet" href="/static/css/checkout.css">
</head>
<body>
    <div class="checkout-container">
        <!-- Lado Izquierdo: Informaci√≥n del Producto -->
        <div class="product-section">
            <div class="header">
                <a href="/home" class="back-btn">
                    <svg fill="currentColor" viewBox="0 0 20 20" width="20" height="20">
                        <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
                    </svg>
                    Volver
                </a>
                <div class="logo">
                    <span>üèóÔ∏è</span> H. Builds
                </div>
            </div>

            <div class="product-details">
                <h1>Resumen de Compra</h1>
                
                <div class="product-card">
                    <div class="product-image">
                        <img src="{{ map.image }}" 
                             alt="{{ map.title }}"
                             onerror="this.onerror=null; this.src='/static/image/HBU.jpg';">
                    </div>
                    
                    <div class="product-info">
                        <h2>{{ map.title }}</h2>
                        <p class="description">{{ map.description }}</p>
                        
                        {% if map.features %}
                        <div class="features">
                            <h3>üìã Caracter√≠sticas:</h3>
                            <ul>
                                {% for feature in map.features.split(',') %}
                                <li>‚úì {{ feature.strip() }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="price-summary">
                    <div class="price-row">
                        <span>Precio del mapa:</span>
                        <span class="amount">${{ "%.2f"|format(map.price) }} USD</span>
                    </div>
                    <div class="price-row">
                        <span>Impuestos:</span>
                        <span class="amount">$0.00 USD</span>
                    </div>
                    <div class="divider"></div>
                    <div class="price-row total">
                        <span>Total:</span>
                        <span class="amount">${{ "%.2f"|format(map.price) }} USD</span>
                    </div>
                </div>

                <div class="security-badges">
                    <div class="badge">
                        <svg fill="currentColor" viewBox="0 0 20 20" width="24" height="24">
                            <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        <span>Pago Seguro</span>
                    </div>
                    <div class="badge">
                        <svg fill="currentColor" viewBox="0 0 20 20" width="24" height="24">
                            <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
                            <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z"/>
                        </svg>
                        <span>Descarga Inmediata</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lado Derecho: Formulario de PayPal -->
        <div class="payment-section">
            <div class="payment-header">
                <h2>M√©todo de Pago</h2>
                <p>Completa tu compra de forma segura con PayPal</p>
            </div>

            <div class="paypal-info">
                <img src="https://www.paypalobjects.com/webstatic/mktg/logo/pp_cc_mark_111x69.jpg" alt="PayPal" class="paypal-logo">
                <p class="info-text">Ser√°s redirigido a PayPal para completar el pago de forma segura</p>
            </div>

            <div class="payment-form">
                <form id="checkoutForm" method="POST" action="/api/purchase/{{ map.id }}">
                    <div class="form-section">
                        <h3>Informaci√≥n de Facturaci√≥n</h3>
                        
                        <div class="form-group">
                            <label for="billing_name">Nombre Completo</label>
                            <input type="text" id="billing_name" name="billing_name" required placeholder="Juan P√©rez">
                        </div>

                        <div class="form-group">
                            <label for="billing_email">Correo Electr√≥nico</label>
                            <input type="email" id="billing_email" name="billing_email" value="{{ user.email }}" required>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="billing_country">Pa√≠s</label>
                                <select id="billing_country" name="billing_country" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="MX">M√©xico</option>
                                    <option value="US">Estados Unidos</option>
                                    <option value="ES">Espa√±a</option>
                                    <option value="AR">Argentina</option>
                                    <option value="CL">Chile</option>
                                    <option value="CO">Colombia</option>
                                    <option value="PE">Per√∫</option>
                                    <option value="VE">Venezuela</option>
                                    <option value="OTHER">Otro</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="billing_zip">C√≥digo Postal</label>
                                <input type="text" id="billing_zip" name="billing_zip" placeholder="12345">
                            </div>
                        </div>
                    </div>

                    <div class="terms-section">
                        <label class="checkbox-label">
                            <input type="checkbox" id="terms" required>
                            <span>Acepto los <a href="/terms" target="_blank">T√©rminos y Condiciones</a> y la <a href="/privacy" target="_blank">Pol√≠tica de Privacidad</a></span>
                        </label>
                    </div>

                    <button type="submit" class="btn-checkout">
                        <svg fill="currentColor" viewBox="0 0 20 20" width="20" height="20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd"/>
                        </svg>
                        Proceder al Pago con PayPal
                    </button>

                    <div class="secure-notice">
                        üîí Tu informaci√≥n est√° protegida con encriptaci√≥n SSL
                    </div>
                </form>
            </div>

            <div class="payment-methods">
                <p>M√©todos de pago aceptados:</p>
                <div class="methods-icons">
                    <img src="https://www.paypalobjects.com/webstatic/mktg/Logo/pp-logo-100px.png" alt="PayPal">
                    <span class="method-icon">üí≥</span>
                    <span class="method-icon">üè¶</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('checkoutForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            // Mostrar loading
            const btn = this.querySelector('.btn-checkout');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner"></span> Procesando...';
            btn.disabled = true;
            
            fetch('/api/purchase/{{ map.id }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.approval_url) {
                    // Redirigir a PayPal
                    window.location.href = data.approval_url;
                } else {
                    alert('Error: ' + (data.message || 'No se pudo procesar el pago'));
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al conectar con el servidor');
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        });
    </script>
</body>
</html>
