<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - H. Builds</title>
    <link rel="stylesheet" href="/static/css/inicio.css">
    <link rel="stylesheet" href="/static/css/profile.css">
    <link rel="stylesheet" href="/static/css/responsive.css">
</head>
<body>
    <div class="particles" id="particles"></div>

    <header>
        <nav>
            <div class="logo" onclick="window.location.href='/home'">
                <span>ğŸ—ï¸</span> H. Builds
            </div>
            <ul class="nav-links">
                <li><a href="/home">Inicio</a></li>
                <li><a href="/home#mapas">Mapas</a></li>
                {% if user.is_admin %}
                <li><a href="/admin">Admin</a></li>
                {% endif %}
            </ul>
            <div class="auth-buttons">
                <button class="btn btn-secondary" onclick="window.location.href='/logout'">Cerrar SesiÃ³n</button>
            </div>
        </nav>
    </header>

    <div class="profile-container">
        <!-- Cabecera del Perfil -->
        <div class="profile-header">
            <div class="profile-picture-section">
                <img src="{{ user.profile_picture if user.profile_picture.startswith('/') else '/static/image/default.jpg' }}" 
                     alt="Foto de perfil" class="profile-picture" id="profilePicture">
                <button class="upload-picture-btn" onclick="document.getElementById('fileInput').click()">
                    ğŸ“·
                </button>
                <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="uploadProfilePicture()">
            </div>

            <div class="profile-info">
                <h1>{{ user.name }}</h1>
                <p class="email">{{ user.email }}</p>
                
                <div class="profile-badges">
                    {% if user.is_admin %}
                    <span class="badge admin">â­ Administrador</span>
                    {% endif %}
                    <span class="badge member">ğŸ® Miembro desde {{ user.created_at.strftime('%Y-%m-%d') }}</span>
                    {% if user.auth_provider == 'google' %}
                    <span class="badge member">ğŸ”— Google</span>
                    {% endif %}
                </div>

                <div class="profile-actions">
                    <button class="btn btn-primary" onclick="openEditModal()">
                        âœï¸ Editar Perfil
                    </button>
                </div>
            </div>
        </div>

        <!-- Contenido del Perfil -->
        <div class="profile-content">
            <!-- Mapas Comprados -->
            <div class="profile-section">
                <h2>ğŸ—ºï¸ Mis Mapas ({{ purchases|length }})</h2>
                
                {% if purchases %}
                <div class="purchases-list">
                    {% for purchase in purchases %}
                    <div class="purchase-item">
                        <div class="purchase-info">
                            <h4>{{ purchase.map.title }}</h4>
                            <p>Comprado el {{ purchase.created_at.strftime('%d/%m/%Y') }}</p>
                            <p style="color: #ff3333; font-weight: 600;">${{ purchase.price }} USD</p>
                        </div>
                        {% if purchase.map.download_link %}
                        <a href="{{ purchase.map.download_link }}" download class="download-btn">
                            â¬‡ï¸ Descargar
                        </a>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p style="color: #aaa; text-align: center; padding: 2rem;">
                    No has comprado ningÃºn mapa todavÃ­a.<br>
                    <a href="/home" style="color: #ff3333;">Explora nuestros mapas</a>
                </p>
                {% endif %}
            </div>

            <!-- EstadÃ­sticas -->
            <div class="profile-section">
                <h2>ğŸ“Š EstadÃ­sticas</h2>
                
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div class="stat-item" style="background: rgba(30, 30, 30, 0.8); padding: 1.5rem; border-radius: 10px; border: 1px solid rgba(255, 51, 51, 0.2);">
                        <h3 style="color: #ff3333; font-size: 2rem; margin: 0;">{{ purchases|length }}</h3>
                        <p style="color: #aaa; margin: 0.5rem 0 0;">Mapas Comprados</p>
                    </div>
                    
                    <div class="stat-item" style="background: rgba(30, 30, 30, 0.8); padding: 1.5rem; border-radius: 10px; border: 1px solid rgba(255, 51, 51, 0.2);">
                        <h3 style="color: #ff3333; font-size: 2rem; margin: 0;">
                            ${{ purchases|sum(attribute='price')|default(0, true) }}
                        </h3>
                        <p style="color: #aaa; margin: 0.5rem 0 0;">Total Gastado</p>
                    </div>
                    
                    <div class="stat-item" style="background: rgba(30, 30, 30, 0.8); padding: 1.5rem; border-radius: 10px; border: 1px solid rgba(255, 51, 51, 0.2);">
                        <h3 style="color: #ff3333; font-size: 2rem; margin: 0;">
                            {{ user.comments|length }}
                        </h3>
                        <p style="color: #aaa; margin: 0.5rem 0 0;">Comentarios Realizados</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Zona de Peligro -->
        {% if not user.is_admin %}
        <div class="danger-zone">
            <h2>âš ï¸ Zona de Peligro</h2>
            <p>Una vez que elimines tu cuenta, no hay vuelta atrÃ¡s. Por favor, ten certeza.</p>
            <button class="btn-danger" onclick="openDeleteModal()">
                ğŸ—‘ï¸ Eliminar Mi Cuenta
            </button>
        </div>
        {% endif %}
    </div>

    <!-- Modal Editar Perfil -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Perfil</h3>
                <button class="close-modal" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editProfileForm" class="edit-profile-form">
                    <div class="form-group">
                        <label for="editName">Nombre</label>
                        <input type="text" id="editName" value="{{ user.name }}" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Correo ElectrÃ³nico (No editable)</label>
                        <input type="email" value="{{ user.email }}" disabled style="opacity: 0.6;">
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeEditModal()">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Confirmar EliminaciÃ³n -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="color: #ff4444;">âš ï¸ Confirmar EliminaciÃ³n</h3>
                <button class="close-modal" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p><strong>Esta acciÃ³n es permanente e irreversible.</strong></p>
                <p>Se eliminarÃ¡n:</p>
                <ul style="color: #aaa; margin-left: 1.5rem; margin-bottom: 1.5rem;">
                    <li>Tu cuenta y perfil</li>
                    <li>Tus comentarios</li>
                    <li>Tu historial de mensajes</li>
                </ul>
                <p style="color: #ff4444;"><strong>Tus compras se mantendrÃ¡n en el registro pero no podrÃ¡s acceder a ellas.</strong></p>
                
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeDeleteModal()">
                        Cancelar
                    </button>
                    <button type="button" class="btn-danger" onclick="confirmDelete()">
                        SÃ­, Eliminar Mi Cuenta
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/profile.js"></script>
</body>
</html>
